const supabaseUrl = 'https://yulyrrrodeiijxdgvkqc.supabase.co';
const supabaseKey = 'eyJhbGciOi...MKF0';
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

const mp = new MercadoPago('APP_USR-499b47b3-fc50-4ec0-b451-7a3da3255400', {
  locale: 'pt-BR'
});

async function carregarRanking() {
  const { data: doacoes, error } = await supabase
    .from('doacoes')
    .select('nome, valor')
    .order('valor', { ascending: false })
    .limit(10);

  const rankingDiv = document.getElementById('rankingDoadores');
  if (error) {
    rankingDiv.innerHTML = '<p>Erro ao carregar ranking</p>';
    return;
  }

  if (!doacoes.length) {
    rankingDiv.innerHTML = '<p>Nenhuma doação ainda. Seja o primeiro!</p>';
    return;
  }

  rankingDiv.innerHTML = doacoes.map((d, i) => `
    <div class="doador-item">
      <span>${i + 1}. ${d.nome || 'Anônimo'}</span>
      <span class="valor">R$ ${d.valor.toFixed(2)}</span>
    </div>
  `).join('');
}

document.getElementById("formDoacao").addEventListener("submit", async (e) => {
  e.preventDefault();
  const nome = document.getElementById("nome").value || "Anônimo";
  const valor = parseFloat(document.getElementById("valor").value);
  const mensagem = document.getElementById("mensagem").value || "";

  const res = await fetch('/api/createPreference', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ nome, valor, mensagem })
  });

  const data = await res.json();

  mp.bricks().create("wallet", "wallet_container", {
    initialization: {
      preferenceId: data.preferenceId
    },
    customization: {
      texts: {
        action: "pay",
        valueProp: "security_details"
      }
    }
  });
});

carregarRanking();
setInterval(carregarRanking, 30000);
